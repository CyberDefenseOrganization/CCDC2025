#!/bin/bash
# Local Security Hardening Script

NEW_PASSWORD="Il0veL1nux@ndhat3wind0ws!"  # Set a new password for all users with /bin/bash
EXCLUDED_USER="whiteteam"

# Change passwords for all users with /bin/bash shell except EXCLUDED_USER
echo "Changing passwords for all users except $EXCLUDED_USER..."
awk -F: '$7 == "/bin/bash" {print $1}' /etc/passwd | while read -r user; do
    if [[ "$user" != "$EXCLUDED_USER" ]]; then
        echo "$user:$NEW_PASSWORD" | sudo chpasswd
        echo "Password changed for user: $user"
    else
        echo "Skipping password change for user: $EXCLUDED_USER"
    fi
done

# Secure SSH configuration
echo "Updating SSH settings..."
sudo sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sudo sed -i 's/^PubkeyAuthentication.*/PubkeyAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/^UsePAM.*/UsePAM no/' /etc/ssh/sshd_config
echo "SSH settings updated."

# Restart SSH service to apply changes
echo "Restarting SSH service..."
sudo systemctl restart ssh
echo "SSH service restarted."

# Clear all user crontab contents without deleting the crontab itself except EXCLUDED_USER
echo "Clearing all user crontabs except $EXCLUDED_USER..."
awk -F: '$7 == "/bin/bash" {print $1}' /etc/passwd | while read -r user; do
    if [[ "$user" != "$EXCLUDED_USER" ]]; then
        echo "" | sudo crontab -u "$user" -
        echo "Cleared crontab content for user: $user"
    else
        echo "Skipping crontab clearing for user: $EXCLUDED_USER"
    fi
done
echo "All crontab contents cleared except for $EXCLUDED_USER."

# Create a backup directory
BACKUP_DIR="$HOME/.setty/backups"
mkdir -p "$BACKUP_DIR"

# Backup the /usr, /etc, /bin, and /sbin directories
echo "Backing up system directories..."
sudo rsync -avz /usr "$BACKUP_DIR/"
sudo rsync -avz /etc "$BACKUP_DIR/"
sudo rsync -avz /bin "$BACKUP_DIR/"
sudo rsync -avz /sbin "$BACKUP_DIR/"
echo "Backups completed."

echo "Local security hardening completed successfully."
